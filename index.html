<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAEZ Pedidos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <style>
        :root {
            /* Tema Claro (Actual con mejoras) */
            --primary-color: #F97316;
            --primary-hover: #EA580C;
            --background-light: #f3f4f6;
            --card-light: #ffffff;
            --text-light: #1f2937;
            
            /* Tema Oscuro */
            --background-dark: #111827; /* Gray 900 */
            --card-dark: #1f2937;      /* Gray 800 */
            --text-dark: #f9fafb;      /* Gray 50 */
            --border-dark: #374151;    /* Gray 700 */

            /* Gradiente Futurista */
            --primary-gradient: linear-gradient(90deg, #F97316, #d946ef); /* Naranja a Fucsia */
            --primary-gradient-hover: linear-gradient(90deg, #EA580C, #c026d3);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-light);
            color: var(--text-light);
        }

        /* Estilos para el Modo Oscuro */
        body.dark {
            background-color: var(--background-dark);
            color: var(--text-dark);
        }
        .dark .bg-white { background-color: var(--card-dark); }
        .dark .bg-gray-50 { background-color: #182133; } /* Un poco más claro que el fondo */
        .dark .bg-gray-100 { background-color: var(--card-dark); }
        .dark .bg-gray-200 { background-color: #374151; }
        .dark .hover\:bg-gray-300:hover { background-color: #4b5563; }
        .dark .text-gray-800 { color: var(--text-dark); }
        .dark .text-gray-700 { color: #d1d5db; } /* Gray 300 */
        .dark .text-gray-500 { color: #9ca3af; } /* Gray 400 */
        .dark .shadow-md, .dark .shadow-lg { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -2px rgba(0, 0, 0, 0.4); }
        .dark .border, .dark .border-b, .dark .border-t { border-color: var(--border-dark); }
        .dark input, .dark select, .dark textarea {
            background-color: #374151;
            border-color: #4b5563;
            color: var(--text-dark);
        }
        .dark dialog::backdrop {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
        }

        /* Botón con Gradiente */
        .btn-primary-gradient {
            background: var(--primary-gradient);
            color: white;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            border: none;
            background-size: 200% auto;
        }
        .btn-primary-gradient:hover {
            background-position: right center;
            transform: scale(1.02);
        }

        /* Animación para tarjetas */
        .order-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .order-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
        }
        .dark .order-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3), 0 4px 6px -4px rgba(0,0,0,0.3);
        }

        /* Animación de entrada para los modales */
        dialog[open] {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Estilos Notificaciones Toast */
        #toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .toast {
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0;
            transform: translateX(100%);
            animation: slideIn 0.5s forwards;
        }
        .toast.success { background-color: #22c55e; }
        .toast.error { background-color: #ef4444; }
        @keyframes slideIn {
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes slideOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Contenedor Principal de la App -->
    <div id="app" class="h-screen w-screen flex flex-col">
        
        <!-- Vista de Login/Selección de Rol -->
        <div id="login-view" class="flex items-center justify-center h-full bg-gray-100">
            <div class="w-full max-w-sm p-8 space-y-6 bg-white rounded-xl shadow-lg text-center">
                <div>
                    <img src="https://i.ibb.co/rG2kW6T2/Picsart-25-08-09-20-48-17-721.jpg" alt="Logo LAEZ" class="w-40 h-40 mx-auto rounded-full shadow-lg">
                    <h1 class="text-3xl font-bold text-gray-800 mt-4">LAEZ Pedidos</h1>
                    <p class="text-gray-500">Tu centro de operaciones creativas</p>
                </div>
                <div class="space-y-4">
                    <h2 class="text-lg font-medium">Selecciona tu rol para continuar</h2>
                    <button id="login-tienda" class="w-full btn-primary-gradient flex items-center justify-center gap-2">
                        <i class="fas fa-store"></i>
                        Entrar como Tienda
                    </button>
                    <button id="login-taller" class="w-full bg-gray-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-800 transition duration-300 shadow-sm flex items-center justify-center gap-2">
                        <i class="fas fa-wrench"></i>
                        Entrar como Taller
                    </button>
                </div>
                 <p id="auth-status" class="text-xs text-gray-400 pt-4">Conectando...</p>
            </div>
        </div>

        <!-- Vista Principal de la App (Tienda/Taller) -->
        <div id="main-view" class="hidden flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="bg-white shadow-md p-4 flex justify-between items-center z-10">
                <div class="flex items-center gap-3">
                     <img src="https://i.ibb.co/rG2kW6T2/Picsart-25-08-09-20-48-17-721.jpg" alt="Logo LAEZ" class="w-10 h-10 rounded-full">
                    <div>
                        <h1 class="text-xl font-bold text-gray-800">LAEZ Pedidos</h1>
                        <p id="user-role-display" class="text-sm text-gray-500"></p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button id="theme-toggle-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-3 rounded-lg hover:bg-gray-300 transition duration-300">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button id="new-order-btn" class="hidden btn-primary-gradient flex items-center gap-2 !py-2 !px-4">
                        <i class="fas fa-plus"></i>
                        <span class="hidden sm:inline">Nuevo Pedido</span>
                    </button>
                     <button id="logout-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-3 rounded-lg hover:bg-gray-300 transition duration-300">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </header>

            <!-- Contenido (Tienda o Taller) -->
            <main class="flex-1 overflow-y-auto p-4 sm:p-6 bg-gray-50">
                <!-- Vista Tienda -->
                <div id="tienda-view-content" class="hidden">
                    <!-- Dashboard de Resumen -->
                    <div id="dashboard" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <!-- Se llenará con JS -->
                    </div>
                    
                    <div class="flex flex-wrap gap-4 mb-4 items-center">
                        <h2 class="text-2xl font-bold text-gray-700">Panel de Pedidos</h2>
                        <div class="relative flex-grow max-w-xs">
                            <input type="text" id="tienda-search" placeholder="Buscar por folio o cliente..." class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        </div>
                        <select id="tienda-filter-status" class="border rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-orange-500">
                        </select>
                    </div>
                    <div id="tienda-orders-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    </div>
                </div>

                <!-- Vista Taller (Kanban) -->
                <div id="taller-view-content" class="hidden h-full flex flex-col">
                     <h2 class="text-2xl font-bold text-gray-700 mb-4">Línea de Producción</h2>
                    <div id="taller-kanban-board" class="flex-1 flex gap-6 overflow-x-auto main-container pb-4">
                    </div>
                </div>

                 <div id="loading-indicator" class="text-center p-10">
                    <i class="fas fa-spinner fa-spin text-4xl text-orange-500"></i>
                    <p class="mt-2 text-gray-600">Cargando la magia...</p>
                </div>
                <div id="no-orders-message" class="hidden text-center p-10 bg-white rounded-lg shadow">
                    <i class="fas fa-folder-open text-5xl text-gray-300"></i>
                    <p class="mt-4 text-xl font-semibold text-gray-600">No hay pedidos para mostrar</p>
                    <p class="text-gray-400">¡Crea un nuevo pedido para empezar a crear!</p>
                </div>
            </main>
        </div>
    </div>

    <!-- Contenedor para notificaciones Toast -->
    <div id="toast-container"></div>

    <!-- Modal para Nuevo/Editar Pedido -->
    <dialog id="order-modal" class="p-0 rounded-xl shadow-2xl w-full max-w-3xl">
        <form id="order-form" class="p-6 sm:p-8 space-y-4 bg-white">
            <div class="flex justify-between items-center pb-3 border-b">
                <h3 id="modal-title" class="text-2xl font-bold">Nuevo Pedido</h3>
                <button type="button" onclick="document.getElementById('order-modal').close()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <input type="hidden" id="order-id">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="client-id" class="block text-sm font-medium text-gray-700">Cliente</label>
                    <div class="flex gap-2">
                        <select id="client-id" name="client_id" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500"></select>
                        <button type="button" id="manage-clients-btn" class="mt-1 bg-gray-200 px-3 rounded-md hover:bg-gray-300"><i class="fas fa-users"></i></button>
                    </div>
                </div>
                 <div>
                    <label for="due-date" class="block text-sm font-medium text-gray-700">Fecha de Entrega</label>
                    <input type="date" id="due-date" name="due_date" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500">
                </div>
            </div>

            <div class="border-t pt-4">
                <h4 class="font-semibold text-lg mb-2">Detalles del Producto</h4>
                 <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                     <div class="md:col-span-2">
                        <label for="product-id" class="block text-sm font-medium text-gray-700">Producto</label>
                        <div class="flex gap-2">
                             <select id="product-id" name="product_id" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500"></select>
                             <button type="button" id="manage-products-btn" class="mt-1 bg-gray-200 px-3 rounded-md hover:bg-gray-300"><i class="fas fa-box-open"></i></button>
                        </div>
                    </div>
                    <div>
                        <label for="quantity" class="block text-sm font-medium text-gray-700">Cantidad</label>
                        <input type="number" id="quantity" name="quantity" min="1" value="1" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500">
                    </div>
                    <div>
                        <label for="price-unit" class="block text-sm font-medium text-gray-700">Precio Unit.</label>
                        <input type="number" step="0.01" id="price-unit" name="price_unit" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500">
                    </div>
                </div>
                <div class="text-right mt-2">
                    <span class="text-sm text-gray-500">Subtotal:</span>
                    <span id="subtotal-display" class="font-bold text-xl text-gray-800">$0.00</span>
                </div>
            </div>
            
            <div class="border-t pt-4">
                 <h4 class="font-semibold text-lg mb-2">Personalización</h4>
                 <textarea id="personalization-notes" name="personalization_notes" rows-="3" placeholder="Ej: 'Feliz Cumpleaños, Papá', tipografía Arial, colores rojo y azul..." class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500"></textarea>
            </div>

            <div class="border-t pt-4">
                <h4 class="font-semibold text-lg mb-2">Imágenes (URLs)</h4>
                <div class="space-y-2">
                     <input type="url" id="ref-image-url-1" placeholder="URL de imagen de referencia 1" class="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500">
                </div>
            </div>

            <div class="flex justify-end gap-4 pt-4 border-t">
                <button type="button" onclick="document.getElementById('order-modal').close()" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                <button type="submit" class="btn-primary-gradient">Guardar Pedido</button>
            </div>
        </form>
    </dialog>
    
    <!-- Modales de Clientes y Productos (sin cambios mayores) -->
    <dialog id="clients-modal" class="p-6 rounded-xl shadow-2xl w-full max-w-lg bg-white">
        <div class="flex justify-between items-center mb-4">
             <h3 class="text-xl font-bold">Gestionar Clientes</h3>
             <button onclick="document.getElementById('clients-modal').close()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times fa-lg"></i></button>
        </div>
        <form id="client-form" class="flex gap-2 mb-4">
             <input type="text" id="client-name" placeholder="Nombre del cliente" required class="flex-grow p-2 border rounded-md">
             <input type="tel" id="client-phone" placeholder="Teléfono" required class="flex-grow p-2 border rounded-md">
             <button type="submit" class="bg-blue-500 text-white font-bold p-2 rounded-md hover:bg-blue-600"><i class="fas fa-plus"></i> Añadir</button>
        </form>
        <div id="clients-list" class="max-h-64 overflow-y-auto space-y-2"></div>
    </dialog>
    <dialog id="products-modal" class="p-6 rounded-xl shadow-2xl w-full max-w-lg bg-white">
        <div class="flex justify-between items-center mb-4">
             <h3 class="text-xl font-bold">Gestionar Productos</h3>
             <button onclick="document.getElementById('products-modal').close()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times fa-lg"></i></button>
        </div>
        <form id="product-form" class="grid grid-cols-3 gap-2 mb-4">
             <input type="text" id="product-name" placeholder="Nombre producto" required class="p-2 border rounded-md">
             <input type="number" id="product-price" placeholder="Precio base" required class="p-2 border rounded-md">
             <button type="submit" class="bg-blue-500 text-white font-bold p-2 rounded-md hover:bg-blue-600"><i class="fas fa-plus"></i> Añadir</button>
        </form>
        <div id="products-list" class="max-h-64 overflow-y-auto space-y-2"></div>
    </dialog>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Tus credenciales de Firebase. ¡Ya están configuradas!
        const firebaseConfig = {
            apiKey: "AIzaSyBH5PBjIKabMpK6fMlE5OcdaWevWZ56Qt8",
            authDomain: "laezz-app.firebaseapp.com",
            projectId: "laezz-app",
            storageBucket: "laezz-app.appspot.com",
            messagingSenderId: "998180579339",
            appId: "1:998180579339:web:0eb781aeccbadb9354ff0e",
            measurementId: "G-LCSRCPG0ZE"
        };
        const appId = firebaseConfig.projectId;
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- ELEMENTOS DEL DOM ---
        const loginView = document.getElementById('login-view');
        const mainView = document.getElementById('main-view');
        const orderModal = document.getElementById('order-modal');
        const orderForm = document.getElementById('order-form');
        const themeToggleButton = document.getElementById('theme-toggle-btn');

        // --- ESTADO DE LA APLICACIÓN ---
        let allOrders = [], allClients = [], allProducts = [];
        let currentRole = null;
        let unsubscribeListeners = [];

        // ESTATUS SIMPLIFICADOS
        const STATUS_OPTIONS = ['Pendiente', 'En Proceso', 'Listo para Entrega', 'Completado'];
        const STATUS_COLORS = {
            'Pendiente': 'bg-blue-100 text-blue-800',
            'En Proceso': 'bg-purple-100 text-purple-800',
            'Listo para Entrega': 'bg-yellow-100 text-yellow-800',
            'Completado': 'bg-green-100 text-green-800',
        };
        const STATUS_ICONS = {
            'Pendiente': 'fas fa-inbox',
            'En Proceso': 'fas fa-cogs',
            'Listo para Entrega': 'fas fa-box-open',
            'Completado': 'fas fa-check-double',
        };

        // --- INICIALIZACIÓN Y AUTENTICACIÓN ---
        onAuthStateChanged(auth, user => {
            if (!user) {
                signInAnonymously(auth).catch(error => {
                    console.error("Error de autenticación anónima:", error);
                    let msg = "Error: Habilita la autenticación anónima en tu Consola de Firebase.";
                    document.getElementById('auth-status').textContent = msg;
                });
            } else {
                 document.getElementById('auth-status').textContent = 'Conectado. ¡Listo!';
                 document.getElementById('auth-status').classList.replace('text-gray-400', 'text-green-500');
            }
        });

        function setupAppForRole(role) {
            currentRole = role;
            loginView.classList.add('hidden');
            mainView.classList.remove('hidden');
            mainView.classList.add('flex');
            
            const roleDisplay = document.getElementById('user-role-display');
            const tiendaContent = document.getElementById('tienda-view-content');
            const tallerContent = document.getElementById('taller-view-content');
            const newOrderBtn = document.getElementById('new-order-btn');

            if (role === 'tienda') {
                roleDisplay.textContent = 'Rol: Tienda';
                tiendaContent.classList.remove('hidden');
                tallerContent.classList.add('hidden');
                newOrderBtn.classList.remove('hidden');
            } else {
                roleDisplay.textContent = 'Rol: Taller';
                tiendaContent.classList.add('hidden');
                tallerContent.classList.remove('hidden');
                newOrderBtn.classList.add('hidden');
            }
            loadAndRenderData();
        }

        function logout() {
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
            currentRole = null;
            mainView.classList.add('hidden');
            loginView.classList.remove('hidden');
        }

        // --- LÓGICA DE DATOS (FIRESTORE) ---
        function getCollectionRef(name) { return collection(db, `/artifacts/${appId}/public/data/${name}`); }

        function loadAndRenderData() {
            document.getElementById('loading-indicator').classList.remove('hidden');
            seedDatabaseIfNeeded();

            const collections = {
                clients: (data) => { allClients = data; populateClientDropdown(); renderClientsList(); },
                products: (data) => { allProducts = data; populateProductDropdown(); renderProductsList(); },
                orders: (data) => { allOrders = data; document.getElementById('loading-indicator').classList.add('hidden'); renderViews(); }
            };

            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = Object.keys(collections).map(name => 
                onSnapshot(getCollectionRef(name), snapshot => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    collections[name](data);
                })
            );
        }

        function renderViews() {
            if (currentRole === 'tienda') {
                renderDashboard();
                renderTiendaView();
            } else {
                renderTallerView();
            }
        }
        
        // --- LÓGICA DE RENDERIZADO ---
        function renderDashboard() {
            const dashboard = document.getElementById('dashboard');
            const pending = allOrders.filter(o => o.status === 'Pendiente').length;
            const inProcess = allOrders.filter(o => o.status === 'En Proceso').length;
            const ready = allOrders.filter(o => o.status === 'Listo para Entrega').length;
            const totalActive = pending + inProcess + ready;

            dashboard.innerHTML = `
                <div class="bg-white p-4 rounded-lg shadow-md text-center">
                    <p class="text-3xl font-bold text-blue-500">${pending}</p>
                    <p class="text-sm text-gray-500">Pendientes</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md text-center">
                    <p class="text-3xl font-bold text-purple-500">${inProcess}</p>
                    <p class="text-sm text-gray-500">En Proceso</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md text-center">
                    <p class="text-3xl font-bold text-yellow-500">${ready}</p>
                    <p class="text-sm text-gray-500">Listos</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md text-center">
                    <p class="text-3xl font-bold text-gray-700">${totalActive}</p>
                    <p class="text-sm text-gray-500">Total Activos</p>
                </div>
            `;
        }

        function renderTiendaView() {
            const list = document.getElementById('tienda-orders-list');
            const search = document.getElementById('tienda-search').value.toLowerCase();
            const status = document.getElementById('tienda-filter-status').value;
            const filtered = allOrders.filter(o => {
                const client = allClients.find(c => c.id === o.client_id);
                return (!status || o.status === status) &&
                       (!search || o.folio.toLowerCase().includes(search) || (client && client.name.toLowerCase().includes(search)));
            });
            list.innerHTML = '';
            document.getElementById('no-orders-message').classList.toggle('hidden', filtered.length > 0);
            filtered.sort((a, b) => (b.created_at?.toMillis() || 0) - (a.created_at?.toMillis() || 0))
                    .forEach(order => list.innerHTML += createOrderCard(order));
        }

        function renderTallerView() {
            const board = document.getElementById('taller-kanban-board');
            board.innerHTML = '';
            const activeStatuses = STATUS_OPTIONS.filter(s => s !== 'Completado');
            const ordersByStatus = activeStatuses.reduce((acc, status) => ({...acc, [status]: allOrders.filter(o => o.status === status)}), {});
            
            const activeCount = Object.values(ordersByStatus).flat().length;
            document.getElementById('no-orders-message').classList.toggle('hidden', activeCount > 0);

            activeStatuses.forEach(status => {
                const column = document.createElement('div');
                column.className = 'w-80 flex-shrink-0 bg-gray-100 rounded-xl p-3 kanban-column';
                const ordersContainer = document.createElement('div');
                ordersContainer.className = 'space-y-4 kanban-orders-container';

                const ordersHTML = ordersByStatus[status]
                    .sort((a, b) => (a.created_at?.toMillis() || 0) - (b.created_at?.toMillis() || 0))
                    .map(createOrderCard).join('');
                
                ordersContainer.innerHTML = ordersHTML;

                column.innerHTML = `
                    <h3 class="font-bold text-lg mb-3 px-2 flex items-center justify-between">
                        <span><i class="${STATUS_ICONS[status]} mr-2"></i>${status}</span>
                        <span class="text-sm font-semibold bg-gray-200 text-gray-700 rounded-full px-2 py-0.5">${ordersByStatus[status].length}</span>
                    </h3>`;
                column.appendChild(ordersContainer);
                board.appendChild(column);
            });

            // Inicializar SortableJS
            const columns = board.querySelectorAll('.kanban-orders-container');
            columns.forEach(col => {
                new Sortable(col, {
                    group: 'kanban',
                    animation: 150,
                    onEnd: async function (evt) {
                        const orderId = evt.item.dataset.id;
                        // El nuevo status es el del texto del H3 de la columna de destino
                        const newStatus = evt.to.parentElement.querySelector('h3 span:first-child').textContent.trim();
                        if (orderId && newStatus) {
                            await updateDoc(doc(getCollectionRef('orders'), orderId), { status: newStatus });
                            showToast(`Pedido movido a ${newStatus}`, 'success');
                        }
                    }
                });
            });
        }
        
        function createOrderCard(order) {
            const client = allClients.find(c => c.id === order.client_id) || { name: 'N/A' };
            const product = allProducts.find(p => p.id === order.product_id) || { name: 'N/A' };
            const dueDate = order.due_date 
                ? new Date(order.due_date + 'T12:00:00Z').toLocaleDateString('es-MX', { timeZone: 'UTC' })
                : 'Fecha no definida';
            const nextStatus = getNextStatus(order.status);
            
            const actionButton = currentRole === 'taller' && nextStatus 
                ? `<button data-id="${order.id}" data-action="next-status" class="btn-primary-gradient !py-1 !px-3 text-xs"><i class="fas fa-arrow-right mr-1"></i> ${nextStatus}</button>` : '';
            const editButtons = currentRole === 'tienda' 
                ? `<button data-id="${order.id}" data-action="edit" class="text-gray-400 hover:text-orange-600"><i class="fas fa-edit"></i></button>
                   <button data-id="${order.id}" data-action="delete" class="text-gray-400 hover:text-red-600"><i class="fas fa-trash"></i></button>` : '';

            // Importante: data-id="${order.id}" en el div principal para SortableJS
            return `
            <div class="bg-white rounded-lg shadow-md p-4 border-l-4 order-card" style="border-color: var(--primary-color)" data-id="${order.id}">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="font-bold text-lg">${client.name}</p>
                        <p class="text-xs text-gray-500 font-mono">${order.folio}</p>
                    </div>
                    <div class="flex items-center gap-2">${editButtons}</div>
                </div>
                <div class="mt-3">
                    <p class="font-semibold">${order.quantity} x ${product.name}</p>
                    <p class="text-sm text-gray-600 truncate">${order.personalization_notes || 'Sin notas.'}</p>
                </div>
                <div class="mt-4 pt-3 border-t flex justify-between items-center">
                    <div class="text-sm">
                        <span class="font-bold text-lg text-gray-700">$${order.subtotal?.toFixed(2) || '0.00'}</span>
                        <p class="text-xs text-gray-500"><i class="far fa-calendar-alt mr-1"></i> ${dueDate}</p>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        <span class="text-xs font-semibold ${STATUS_COLORS[order.status]} px-2 py-1 rounded-full"><i class="${STATUS_ICONS[order.status]} mr-1.5"></i>${order.status}</span>
                        ${actionButton}
                    </div>
                </div>
            </div>`;
        }
        
        // --- MANEJO DE FORMULARIOS Y MODALES ---
        function openOrderModal(order = null) {
            orderForm.reset();
            document.getElementById('order-id').value = order ? order.id : '';
            document.getElementById('modal-title').textContent = order ? `Editar Pedido ${order.folio}` : 'Nuevo Pedido';
            
            if (order) {
                Object.keys(order).forEach(key => {
                    const el = document.getElementById(key);
                    if (el) el.value = order[key];
                });
                document.getElementById('ref-image-url-1').value = order.image_urls?.[0] || '';
            } else {
                const today = new Date();
                today.setDate(today.getDate() + 3);
                document.getElementById('due-date').value = today.toISOString().split('T')[0];
            }
            updateSubtotal();
            orderModal.showModal();
        }

        function updateSubtotal() {
            const quantity = parseInt(document.getElementById('quantity').value) || 0;
            const price = parseFloat(document.getElementById('price-unit').value) || 0;
            const subtotal = quantity * price;
            document.getElementById('subtotal-display').textContent = `$${subtotal.toFixed(2)}`;
        }
        
        async function handleOrderFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('order-id').value;
            const quantity = parseInt(document.getElementById('quantity').value);
            const price_unit = parseFloat(document.getElementById('price-unit').value);
            const orderData = {
                client_id: document.getElementById('client-id').value,
                due_date: document.getElementById('due-date').value,
                product_id: document.getElementById('product-id').value,
                quantity,
                price_unit,
                subtotal: quantity * price_unit,
                personalization_notes: document.getElementById('personalization-notes').value,
                image_urls: [document.getElementById('ref-image-url-1').value.trim()].filter(Boolean),
            };

            try {
                 if (id) {
                    await updateDoc(doc(getCollectionRef('orders'), id), orderData);
                    showToast('¡Pedido actualizado con éxito!', 'success');
                } else {
                    orderData.folio = `LAEZ-${new Date().toISOString().slice(0, 10).replace(/-/g, '')}-${String(Date.now()).slice(-4)}`;
                    orderData.status = 'Pendiente';
                    orderData.created_at = Timestamp.now();
                    await addDoc(getCollectionRef('orders'), orderData);
                    showToast('¡Pedido creado con éxito!', 'success');
                }
                orderModal.close();
            } catch (error) { 
                console.error("Error al guardar pedido:", error);
                showToast('Error al guardar el pedido.', 'error');
            }
        }

        async function handleOrderAction(e) {
            const target = e.target.closest('button[data-id]');
            if (!target) return;
            const { id, action } = target.dataset;
            const order = allOrders.find(o => o.id === id);
            if (!order) return;

            if (action === 'edit') openOrderModal(order);
            if (action === 'delete' && confirm('¿Seguro que quieres eliminar este pedido?')) await deleteDoc(doc(getCollectionRef('orders'), id));
            if (action === 'next-status') await updateDoc(doc(getCollectionRef('orders'), id), { status: getNextStatus(order.status) });
        }
        
        // --- UTILIDADES ---
        const populateDropdown = (id, data, nameField) => {
            const select = document.getElementById(id);
            select.innerHTML = `<option value="">Selecciona...</option>`;
            data.forEach(item => select.innerHTML += `<option value="${item.id}">${item[nameField]}</option>`);
        };
        const populateClientDropdown = () => populateDropdown('client-id', allClients, 'name');
        const populateProductDropdown = () => populateDropdown('product-id', allProducts, 'name');
        
        function populateStatusFilter() {
             const select = document.getElementById('tienda-filter-status');
             select.innerHTML = '<option value="">Todos los Estatus</option>';
             STATUS_OPTIONS.forEach(s => select.innerHTML += `<option value="${s}">${s}</option>`);
        }
        
        function getNextStatus(currentStatus) {
            const currentIndex = STATUS_OPTIONS.indexOf(currentStatus);
            return (currentIndex > -1 && currentIndex < STATUS_OPTIONS.length - 1) ? STATUS_OPTIONS[currentIndex + 1] : null;
        }

        // --- CRUD para Clientes y Productos ---
        const renderList = (containerId, data, nameField, phoneField) => {
            const list = document.getElementById(containerId);
            list.innerHTML = data.map(item => `
                <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                    <span>${item[nameField]} (${phoneField ? (item[phoneField] || 'N/A') : `$${item.base_price}`})</span>
                    <button data-id="${item.id}" data-type="${containerId.replace('-list','')}" class="text-red-500 hover:text-red-700 delete-item-btn"><i class="fas fa-trash"></i></button>
                </div>`).join('');
        };
        const renderClientsList = () => renderList('clients-list', allClients, 'name', 'phone');
        const renderProductsList = () => renderList('products-list', allProducts, 'name');

        const setupCrudForm = (formId, collectionName, fields) => {
            document.getElementById(formId).addEventListener('submit', async (e) => {
                e.preventDefault();
                const data = fields.reduce((acc, field) => ({...acc, [field.name]: document.getElementById(field.id).value}), {});
                await addDoc(getCollectionRef(collectionName), data);
                e.target.reset();
            });
        };
        
        document.addEventListener('click', async (e) => {
            const button = e.target.closest('.delete-item-btn');
            if (button && confirm('¿Seguro que quieres eliminar este elemento?')) {
                await deleteDoc(doc(getCollectionRef(button.dataset.type), button.dataset.id));
            }
        });

        // --- TEMA OSCURO ---
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark');
                themeToggleButton.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                document.body.classList.remove('dark');
                themeToggleButton.innerHTML = '<i class="fas fa-moon"></i>';
            }
        }
        themeToggleButton.addEventListener('click', () => {
            const newTheme = document.body.classList.contains('dark') ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });

        // --- NOTIFICACIONES TOAST ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.5s forwards';
                toast.addEventListener('animationend', () => toast.remove());
            }, 3000);
        }
        
        // --- SEED DATA (Solo para la primera vez) ---
        async function seedDatabaseIfNeeded() {
            if ((await getDocs(getCollectionRef('orders'))).empty) {
                console.log("Base de datos vacía, insertando datos de ejemplo...");
                const p1 = await addDoc(getCollectionRef('products'), { name: 'Taza 11oz', base_price: 120 });
                const c1 = await addDoc(getCollectionRef('clients'), { name: 'Ana Pérez', phone: '9611234567' });
                await addDoc(getCollectionRef('orders'), { folio: 'LAEZ-DEMO-001', client_id: c1.id, product_id: p1.id, quantity: 2, price_unit: 120, subtotal: 240, personalization_notes: 'Logo de Batman.', status: 'Pendiente', created_at: Timestamp.now(), due_date: '2025-09-10' });
            }
        }
        
        // --- EVENT LISTENERS ---
        document.getElementById('login-tienda').addEventListener('click', () => setupAppForRole('tienda'));
        document.getElementById('login-taller').addEventListener('click', () => setupAppForRole('taller'));
        document.getElementById('logout-btn').addEventListener('click', logout);
        document.getElementById('new-order-btn').addEventListener('click', () => openOrderModal());
        orderForm.addEventListener('submit', handleOrderFormSubmit);
        ['tienda-orders-list', 'taller-kanban-board'].forEach(id => document.getElementById(id).addEventListener('click', handleOrderAction));
        ['tienda-search', 'tienda-filter-status'].forEach(id => document.getElementById(id).addEventListener('input', renderTiendaView));
        ['quantity', 'price-unit'].forEach(id => document.getElementById(id).addEventListener('input', updateSubtotal));
        
        document.getElementById('manage-clients-btn').addEventListener('click', () => document.getElementById('clients-modal').showModal());
        document.getElementById('manage-products-btn').addEventListener('click', () => document.getElementById('products-modal').showModal());

        setupCrudForm('client-form', 'clients', [{id: 'client-name', name: 'name'}, {id: 'client-phone', name: 'phone'}]);
        setupCrudForm('product-form', 'products', [{id: 'product-name', name: 'name'}, {id: 'product-price', name: 'base_price'}]);
        
        document.getElementById('product-id').addEventListener('change', (e) => {
            const product = allProducts.find(p => p.id === e.target.value);
            if (product) document.getElementById('price-unit').value = product.base_price;
            updateSubtotal();
        });

        // --- INICIO ---
        const savedTheme = localStorage.getItem('theme') || 'light';
        applyTheme(savedTheme);
        populateStatusFilter();

    </script>
</body>
</html>

